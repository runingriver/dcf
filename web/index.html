<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCF 估值计算器</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>自由现金流折现（DCF）估值</h1>
      <form method="post" action="/compute" class="grid" id="dcf-form">
      <label>
        下一年自由现金流（亿）
        <input type="number" step="0.0001" name="fcf" id="fcf" min="0" required value="{{ with .Input }}{{ printf "%.4f" .FCFBase }}{{ end }}"/>
      </label>
      <label>
        总股本（亿）
        <input type="number" step="0.0001" name="shares" id="shares" min="0" required value="{{ with .Input }}{{ printf "%.4f" .TotalShares }}{{ end }}"/>
      </label>
      <label>
        贴现率WACC（%）
        <input type="number" step="0.0001" name="r" id="r" required value="{{ with .Input }}{{ printf "%.4f" .DiscountRatePct }}{{ end }}"/>
      </label>
      <label>
        永续增长率（%）
        <input type="number" step="0.0001" name="gp" id="gp" required value="{{ with .Input }}{{ printf "%.4f" .PerpetualGrowthPct }}{{ end }}"/>
      </label>
      <label>
        一阶段年数 N
        <input type="number" name="n" id="n" min="1" required value="{{ with .Input }}{{ .Years }}{{ end }}"/>
      </label>
      <label>
        未来N年自由现金流年均增长率（%）
        <input type="number" step="0.0001" name="g" id="g" required value="{{ with .Input }}{{ printf "%.4f" .AvgGrowthRatePct }}{{ end }}"/>
      </label>
        <div class="actions">
          <button type="submit">计算</button>
        </div>
      </form>
      <div class="error" id="form-error"></div>
    </div>

    {{ if .Error }}
      <div class="error">错误：{{ .Error }}</div>
    {{ end }}

    {{ if .Result }}
    <div class="card results">
      <h2>计算结果</h2>
      <div class="summary">
        <span class="badge">下一年FCF {{ printf "%.4f" .Input.FCFBase }} 亿</span>
        <span class="badge">股本 {{ printf "%.4f" .Input.TotalShares }} 亿股</span>
        <span class="badge">r(WACC) {{ printf "%.2f" .Input.DiscountRatePct }}%</span>
        <span class="badge">g {{ printf "%.2f" .Input.AvgGrowthRatePct }}%</span>
        <span class="badge">gp {{ printf "%.2f" .Input.PerpetualGrowthPct }}%</span>
        <span class="badge">N {{ .Input.Years }}</span>
      </div>
      <div class="formula">
        <p>r（WACC）：贴现率（加权平均资本成本，按百分比输入）</p>
        <p>g：一阶段自由现金流年均增长率（按百分比输入）</p>
        <p>gp：永续增长率（稳定期，按百分比输入）</p>
      </div>

      <h3>第一步：预测N年的自由现金流（单位：亿）</h3>
      <p class="formula">公式：FCF_t = FCF_{t-1} × (1 + g)，其中 g={{ printf "%.2f" .Input.AvgGrowthRatePct }}%</p>
      <ul class="list">
        {{ range $i, $v := .Result.ProjectedFCF }}
          <li><span>第{{ add $i 1 }}年</span><span>{{ printf "%.4f" $v }}</span></li>
        {{ end }}
      </ul>

      <h3>第二步：把这N年自由现金流折现成现值（单位：亿）</h3>
      <p class="formula">公式：PV_t = FCF_t / (1 + r)^t，其中 r={{ printf "%.2f" .Input.DiscountRatePct }}%</p>
      <ul class="list">
        {{ range $i, $v := .Result.DiscountedFCF }}
          <li><span>第{{ add $i 1 }}年现值</span><span>{{ printf "%.4f" $v }}</span></li>
        {{ end }}
      </ul>

      <h3>第三步：永续年金价值及其现值</h3>
      <p class="formula">公式：TV = FCF_N × (1 + gp) / (r − gp)</p>
      <p class="formula">公式：PV_TV = TV / (1 + r)^N</p>
      <p class="formula">代入：FCF_N={{ printf "%.4f" (index .Result.ProjectedFCF (sub .Input.Years 1)) }}，r={{ printf "%.2f" .Input.DiscountRatePct }}%，gp={{ printf "%.2f" .Input.PerpetualGrowthPct }}%，N={{ .Input.Years }}，(1+r)^N={{ printf "%.6f" (pow (onePlusPct .Input.DiscountRatePct) .Input.Years) }}</p>
      <p>永续年金价值（第N年末）：{{ printf "%.4f" .Result.TerminalValue }} (亿)</p>
      <p>折现到当期的现值：{{ printf "%.4f" .Result.DiscountedTerminal }} (亿)</p>

      <h3>第四步：企业价值</h3>
      <p class="formula">公式：Firm = Σ PV_t + PV_TV</p>
      <p>企业价值：{{ printf "%.4f" .Result.FirmValue }} (亿)</p>

      <h3>第五步：每股价值</h3>
      <p class="formula">公式：PerShare = Firm / TotalShares，其中 TotalShares={{ printf "%.4f" .Input.TotalShares }} 亿股</p>
      <p>每股价值：{{ printf "%.6f" .Result.PerShareValue }}</p>
    </div>
    {{ end }}
  </div>

  <script>
    const form = document.getElementById('dcf-form');
    const errBox = document.getElementById('form-error');
    const num = id => parseFloat(document.getElementById(id).value);
    function validate() {
      errBox.textContent = '';
      errBox.classList.remove('show');
      const fcf = num('fcf');
      const shares = num('shares');
      const r = num('r');
      const gp = num('gp');
      const n = parseInt(document.getElementById('n').value, 10);
      const g = num('g');
      const setErr = msg => { errBox.textContent = msg; errBox.classList.add('show'); };
      if (isNaN(fcf) || fcf <= 0) { setErr('请填写有效的下一年自由现金流（>0）'); return false; }
      if (isNaN(shares) || shares <= 0) { setErr('请填写有效的总股本（>0）'); return false; }
      if (isNaN(r)) { setErr('请填写有效的贴现率（%）'); return false; }
      if (isNaN(gp)) { setErr('请填写有效的永续增长率（%）'); return false; }
      if (isNaN(g)) { setErr('请填写有效的年均增长率（%）'); return false; }
      if (isNaN(n) || n < 1) { setErr('一阶段年数必须为>=1的整数'); return false; }
      if (r <= gp) { setErr('贴现率必须大于永续增长率'); return false; }

      // 额外防误填：百分比必须以“百分数”输入（例如 10 表示 10%），而不是小数（例如 0.1）。
      // 如果检测到 0 < 值 <= 1 的情况，极可能是误把 10% 写成 0.1。
      const isPctLikelyDecimal = v => v > 0 && v <= 1;
      if (isPctLikelyDecimal(r) || isPctLikelyDecimal(g) || isPctLikelyDecimal(gp)) {
        setErr('请按百分比输入（例如 10 表示 10%），不要输入 0.1 或 0.08');
        return false;
      }
      return true;
    }
    ['fcf','shares','r','gp','n','g'].forEach(id => {
      const el = document.getElementById(id);
      el && el.addEventListener('input', () => { validate(); });
    });
    form.addEventListener('submit', (e) => { if (!validate()) { e.preventDefault(); } });
  </script>
</body>
</html>
